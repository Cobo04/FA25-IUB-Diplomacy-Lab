<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Report</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.6.5/jspdf.umd.min.js"></script>
</head>

<body>
    <script>
        // Robust loader: tries multiple CDNs and only runs when jsPDF is available
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = () => resolve(src);
                s.onerror = () => reject(new Error('Failed to load ' + src));
                document.head.appendChild(s);
            });
        }

        async function ensureJsPDF() {
            // Try a list of known-good UMD builds
            const urls = [
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js'
            ];

            // If jsPDF already present, return immediately
            if (window.jspdf || window.jsPDF) return;

            for (const url of urls) {
                try {
                    // eslint-disable-next-line no-await-in-loop
                    await loadScript(url);
                    if (window.jspdf || window.jsPDF) return;
                } catch (e) {
                    // try next
                }
            }

            // final check
            if (!window.jspdf && !window.jsPDF) throw new Error('jsPDF failed to load from CDNs');
        }

        window.addEventListener('load', async () => {
            try {
                await ensureJsPDF();

                // wait for webfonts to finish loading so they render correctly
                if (document.fonts && document.fonts.ready) {
                    await document.fonts.ready;
                }

                const element = document.querySelector('.report-container') || document.body;
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, allowTaint: false });
                const imgData = canvas.toDataURL('image/png');

                // get jsPDF constructor from common UMD exports
                let jsPDFCtor = null;
                if (window.jspdf && window.jspdf.jsPDF) jsPDFCtor = window.jspdf.jsPDF;
                else if (window.jsPDF) jsPDFCtor = window.jsPDF;
                else if (typeof window.jspdf === 'function') jsPDFCtor = window.jspdf;

                if (!jsPDFCtor) {
                    console.error('jsPDF constructor not found after loading');
                    return;
                }

                // create PDF and calculate sizes
                const pdf = new jsPDFCtor({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // small margin in mm; set to 0 to try to eliminate all white edges
                const margin = 4; // set to 0 if you want truly edge-to-edge (may be cropped by viewers/printers)

                // convert px to mm (assume 96 DPI)
                const pxToMm = px => px * 25.4 / 96;
                const imgWidthMm = pxToMm(canvas.width);
                const imgHeightMm = pxToMm(canvas.height);

                // available area inside margins
                const availWidth = pageWidth - 2 * margin;
                const availHeight = pageHeight - 2 * margin;

                // scale image to fill the available area (fit by width or height)
                const ratio = Math.min(availWidth / imgWidthMm, availHeight / imgHeightMm);
                const renderWidth = imgWidthMm * ratio;
                const renderHeight = imgHeightMm * ratio;

                // position image flush inside margins (centered within available area)
                const x = margin + Math.max(0, (availWidth - renderWidth) / 2);
                const y = margin + Math.max(0, (availHeight - renderHeight) / 2);

                // add image and save
                pdf.addImage(imgData, 'PNG', x, y, renderWidth, renderHeight);
                pdf.save('report.pdf');
            } catch (err) {
                console.error('Error creating PDF', err);
            }
        });
    </script>
    <div class="report-container">
        <h1 class="report-title">Automated Report for {{ company['chinese_name'] }} - {{ company['english_translation'] }}</h1>
    </div>
</body>